<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Minutrix — Acompanhamento Inteligente · Minutas em dia</title>
<link id="favicon" rel="icon" type="image/svg+xml" />

<style>
  :root{
    --bg:#0a1015;--panel:#0e1820;--ink:#e8f2ff;--muted:#94a7b6;--border:#182531;
    --ok:#1de9b6;--bad:#ff5c77;--warn:#ffd166;--accent:#14c6b7
  }
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(1200px 800px at 20% -10%,#0d1b24 0%,#0a1015 55%,#080e13 100%);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  header{padding:14px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,#0f1a22,#0d1720);position:sticky;top:0;z-index:10}
  h1{margin:0;font-weight:800;font-size:20px;letter-spacing:.2px}
  .brand{display:flex;align-items:center;gap:12px}
  .brand img{height:36px;width:36px;border-radius:10px;border:1px solid #0e2b2c;background:#071316;box-shadow:0 0 0 2px rgba(20,198,183,.15)}
  .brand small{display:block;color:var(--muted)}
  .wrap{max-width:1200px;margin:auto;padding:14px}
  nav{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
  .tab{padding:8px 14px;border-radius:12px;border:1px solid var(--border);background:#0b141b;color:#b8c7d3;cursor:pointer;transition:.15s}
  .tab:hover{transform:translateY(-1px)}
  .tab.active{background:var(--accent);color:#00110f;border-color:transparent;box-shadow:0 8px 30px rgba(20,198,183,.25)}
  .grid{display:grid;gap:12px;grid-template-columns:repeat(4,minmax(0,1fr))}
  .k{background:linear-gradient(180deg,#0d1620,#0a1015);border:1px solid var(--border);padding:14px;border-radius:14px}
  .k .t{color:var(--muted);font-size:12px;margin-bottom:6px}
  .k .v{font-weight:900;font-size:28px}
  .k .chip{display:inline-block;padding:2px 8px;border-radius:9999px;border:1px solid #14343b;background:rgba(20,198,183,.1);color:#93fff1;font-size:12px;margin-left:6px}
  #err{display:none;margin:12px 0;padding:10px;border:1px solid #733040;background:#451b26;color:#ffdbe1;border-radius:12px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
  input,select{background:#0b141b;border:1px solid var(--border);color:#e8f2ff;padding:9px 10px;border-radius:10px}
  button{background:#13212b;border:1px solid var(--border);color:#e8f2ff;padding:9px 12px;border-radius:12px;cursor:pointer}
  button.primary{background:var(--accent);color:#011412;border-color:transparent}
  table{width:100%;border-collapse:separate;border-spacing:0 6px;margin-top:6px}
  thead th{color:#9fb0bf;text-align:left;font-size:12px;letter-spacing:.3px}
  tbody td{background:linear-gradient(180deg,#0e1821,#0a1117);border:1px solid var(--border);padding:10px}
  tbody tr td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
  tbody tr td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
  .badge{padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;display:inline-block}
  .ok{background:rgba(29,233,182,.12);color:#9bffe6}
  .warn{background:rgba(255,209,102,.12);color:#ffe3a6}
  .bad{background:rgba(255,92,119,.12);color:#ffc1cc}
  .muted{color:var(--muted)}
  .tabv{animation:fade .15s ease}
  @keyframes fade{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
  /* Power BI responsivo */
  .bi-frame{position:relative;padding-top:56.25%;border:1px solid var(--border);border-radius:14px;overflow:hidden;background:#0b141b}
  .bi-frame iframe{position:absolute;inset:0;width:100%;height:100%;border:0}
  /* subtabs na Tabela */
  .subnav{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 4px}
  .subtab{padding:6px 10px;border-radius:9999px;border:1px solid var(--border);background:#0b141b;color:#8fb0c1;cursor:pointer}
  .subtab.active{background:#11242d;color:#dbf9ff;border-color:#1f3844}
</style>
<script src="https://www.gstatic.com/charts/loader.js"></script>
</head>
<body>
<header class="wrap">
  <div class="brand">
    <img id="logo" alt="Logo">
    <div>
      <h1>Minutrix — Acompanhamento Inteligente</h1>
      <small>Minutas em dia</small>
    </div>
  </div>
  <nav>
    <button class="tab active" data-tab="painel">Painel</button>
    <button class="tab" data-tab="tabela">Tabela</button>
    <button class="tab" data-tab="bi">Power BI</button>
    <button class="tab" data-tab="diag">Diagnóstico</button>
  </nav>
</header>

<main class="wrap">
  <div id="err"></div>

  <!-- PAINEL -->
  <section id="painel" class="tabv" style="display:block">
  <div class="grid">
    <div class="k"><div class="t">Registros</div><div id="k_total" class="v">—</div></div>
    <div class="k"><div class="t">Dentro do prazo</div><div id="k_ok" class="v">—</div></div>
    <div class="k"><div class="t">Fora do prazo</div><div id="k_late" class="v">—</div></div>
    <div class="k"><div class="t">% no prazo</div><div id="k_pct" class="v">—</div></div>
  </div>

  <!-- NOVO: Gráfico quantidade por advogado -->
  <div class="k" style="margin-top:12px">
    <div class="t">Quantidade por Advogado</div>
    <div id="chart_adv" style="height:380px"></div>
  </div>
</section>

  <!-- TABELA (colunas enxutas) -->
  <section id="tabela" class="tabv" style="display:none">
    <!-- SUB-ABAS: Advogado · Cliente · Situação (Hoje) -->
    <div class="subnav">
      <button class="subtab active" data-sub="all">Todos</button>
      <button class="subtab" data-sub="adv">Advogado</button>
      <button class="subtab" data-sub="cli">Cliente</button>
      <button class="subtab" data-sub="sit">Situação (Hoje)</button>
    </div>

    <div class="controls" id="controls_all" style="display:flex">
      <input id="q" placeholder="Buscar: ID, prazo, advogado, cliente..."/>
      <select id="f_adv"><option value="">Advogado: Todos</option></select>
      <select id="f_cli"><option value="">Cliente: Todos</option></select>
      <select id="f_hoje">
        <option value="">Situação (Hoje): Todas</option>
        <option value="OK">OK</option>
        <option value="A_VENCER">A_VENCER</option>
        <option value="VENCIDO">VENCIDO</option>
      </select>
      <button id="filtrar" class="primary">Filtrar</button>
      <button id="limpar">Limpar</button>
    </div>

    <div class="controls" id="controls_adv" style="display:none">
      <select id="f_adv_only"><option value="">Advogado: Todos</option></select>
      <button id="filtrar_adv" class="primary">Aplicar</button>
    </div>

    <div class="controls" id="controls_cli" style="display:none">
      <select id="f_cli_only"><option value="">Cliente: Todos</option></select>
      <button id="filtrar_cli" class="primary">Aplicar</button>
    </div>

    <div class="controls" id="controls_sit" style="display:none">
      <select id="f_sit_only">
        <option value="">Situação (Hoje): Todas</option>
        <option value="OK">OK</option>
        <option value="A_VENCER">A_VENCER</option>
        <option value="VENCIDO">VENCIDO</option>
      </select>
      <button id="filtrar_sit" class="primary">Aplicar</button>
    </div>

    <table>
      <thead><tr>
        <th>ID</th><th>Prazo</th><th>Advogado</th><th>Cliente</th>
        <th>Data Fatal</th><th>Data Envio</th><th>SLA</th><th>DU</th><th>Hoje</th>
      </tr></thead>
      <tbody id="tb"></tbody>
    </table>
    <div id="rows" class="muted" style="margin-top:6px">—</div>
  </section>

  <!-- POWER BI -->
  <section id="bi" class="tabv" style="display:none">
    <div class="k" style="margin-bottom:12px"><div class="t">Dashboard</div>
      <div class="chip">Power BI</div>
    </div>
    <div class="bi-frame"><iframe id="bi_iframe" loading="lazy" allowfullscreen></iframe></div>
  </section>

  <!-- DIAGNÓSTICO -->
  <section id="diag" class="tabv" style="display:none">
    <div class="k" id="diagBox" style="white-space:pre-wrap"></div>
  </section>
</main>

<script>
/* ===== CONFIG ===== */
const SHEET_ID   = '1iGdB-aGM5xh0cJx5IdhGHzRYlAOU15HqhR-Lohlv3KI';
const GID        = '1935308703';
const GVIZ_URL   = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${GID}&tq=select%20*`;
const POWERBI_URL= 'https://app.powerbi.com/view?r=eyJrIjoiYTM1N2IxZGMtOTFiNC00YzViLTk3OTEtOTY3YzRmNWFiOTEyIiwidCI6IjM2NDZmODI0LWFjNDQtNDViNC1hNjllLTQ0YWI1MTBmNmFhZiJ9';
// --- LOGO MINUTRIX embutida (SVG) ---
const LOGO_SVG = `
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
  <defs>
    <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#14c6b7"/>
      <stop offset="1" stop-color="#1de9b6"/>
    </linearGradient>
  </defs>
  <rect x="1.5" y="1.5" width="61" height="61" rx="12" ry="12"
        fill="#0b141b" stroke="#1f3844" stroke-width="3"/>
  <path d="M14 46 L14 18 L26 36 L38 18 L38 46"
        fill="none" stroke="url(#g)" stroke-width="6"
        stroke-linecap="round" stroke-linejoin="round"/>
  <circle cx="48" cy="22" r="3.8" fill="url(#g)"/>
</svg>`;
const LOGO_URL = 'data:image/svg+xml;utf8,' + encodeURIComponent(LOGO_SVG);

// aplica no header e no favicon
const logoEl = document.getElementById('logo');
if (logoEl) logoEl.src = LOGO_URL;
const fav = document.getElementById('favicon');
if (fav) fav.href = LOGO_URL;

/* ===== UI ===== */
const $  = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));
if ($('#logo')) { if (LOGO_URL) $('#logo').src = LOGO_URL; else $('#logo').style.display='none'; }
$$('.tab').forEach(b=> b.addEventListener('click',()=>{
  $$('.tab').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  $$('.tabv').forEach(v=> v.style.display = (v.id===b.dataset.tab?'block':'none'));
  if (b.dataset.tab==='bi') { const f=$('#bi_iframe'); if(f && !f.src) f.src = POWERBI_URL; } // lazy-load BI
}));

// Sub-abas da Tabela
const subViews = {
  all:  ['controls_all'],
  adv:  ['controls_adv'],
  cli:  ['controls_cli'],
  sit:  ['controls_sit']
};
$$('.subtab').forEach(b=> b.addEventListener('click',()=>{
  $$('.subtab').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  const target=b.dataset.sub;
  Object.values(subViews).flat().forEach(id=> $('#'+id).style.display='none');
  (subViews[target]||[]).forEach(id=> $('#'+id).style.display='flex');
}));

/* ===== Google Loader ===== */
google.charts.load('current', {'packages':[]});
google.charts.setOnLoadCallback(loadGViz);

/* ===== Estado ===== */
const S = {rows:[], filtered:[]};
const F = {q:'',adv:'',cli:'',hoje:''};

/* ===== Datas & SLA (inalterado) ===== */
function toDate(v){ if(!v) return null; if(v instanceof Date) return v;
  const s=String(v).trim(), m=s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
  if(m){ const d=+m[1], mo=+m[2]-1, y=m[3].length===2?2000+ +m[3]:+m[3]; return new Date(y,mo,d); }
  const n=Number(s); if(!isNaN(n)&&n>20000&&n<10000000000000) return new Date(n);
  const d=new Date(s); return isNaN(d)? null : d;
}
function bizDiff(a,b){ if(!a||!b) return null; const A=new Date(a),B=new Date(b);
  let d=0, dir=A<=B?1:-1, cur=new Date(A); cur.setHours(12,0,0,0); B.setHours(12,0,0,0);
  while((dir>0&&cur<B)||(dir<0&&cur>B)){ cur.setDate(cur.getDate()+dir); const w=cur.getDay(); if(w!==0&&w!==6) d+=dir; }
  return d;
}
function classify(r){
  const du=bizDiff(r.data_envio,r.data_fatal);
  const sla= du==null?'—': du>=2?'D-2':du===1?'D-1':du===0?'D0':`D+${Math.abs(du)}`;
  const today=new Date(); today.setHours(12,0,0,0);
  const df=r.data_fatal? new Date(r.data_fatal): null; if(df) df.setHours(12,0,0,0);
  const delta=df? bizDiff(today,df): null;
  const hoje= delta==null? '—' : (delta<0?'VENCIDO' : (delta<=2?'A_VENCER':'OK'));
  return {du,sla,hoje};
}
function pick(obj, keys){
  for(const k of keys){
    if(obj[k]!=null && obj[k]!=='') return obj[k];
    const found = Object.keys(obj).find(x=>x.toLowerCase().includes(k.toLowerCase()));
    if(found) return obj[found];
  } return '';
}

/* ===== Carga (GViz JSONP) ===== */
function loadGViz(){
  const q = new google.visualization.Query(GVIZ_URL);
  q.send(resp=>{
    if(resp.isError()){ fail(`GViz error: ${resp.getMessage()}`); return; }
    const data = resp.getDataTable();
    const cols = Array.from({length:data.getNumberOfColumns()}, (_,i)=> data.getColumnLabel(i) || data.getColumnId(i));
    const rows = Array.from({length:data.getNumberOfRows()}, (_,r)=> { const o={}; cols.forEach((c,i)=>o[c]=data.getValue(r,i) ?? ''); return o; });

    // mapear só as colunas essenciais (as datas que você pediu para tirar NÃO entram)
    S.rows = rows.map(r=>({
      id:        pick(r,['id prazo','id']),
      prazo:     pick(r,['prazo (descrição)','descrição do prazo','prazo','descricao']),
      advogado:  pick(r,['executor do prazo','advogado','responsável','executor']),
      cliente:   pick(r,['cliente']),
      data_fatal:toDate(pick(r,['data fatal','prazo fatal','data do prazo','data limite'])),
      data_envio:toDate(pick(r,['data envio','envio de minuta','data do envio','data de envio','envio']))
    })).map(r=>Object.assign(r, classify(r)))
      .filter(r=> r.id || r.prazo || r.advogado || r.cliente);

    S.filtered=[...S.rows];
    hydrateFilters();
    render();drawAdvChart();

    const info=['Fonte GViz: '+GVIZ_URL,'','Colunas detectadas:',...cols.map(c=>'• '+c)].join('\n');
    const box=document.getElementById('diagBox'); if(box) box.textContent=info;
  });
}

/* ===== Filtros ===== */
function hydrateFilters(){
  const advs=[...new Set(S.rows.map(r=>r.advogado).filter(Boolean))].sort();
  const clis=[...new Set(S.rows.map(r=>r.cliente).filter(Boolean))].sort();
  const selAdv=$('#f_adv'), selCli=$('#f_cli'), selAdvOnly=$('#f_adv_only'), selCliOnly=$('#f_cli_only');

  const advOpts = '<option value="">Advogado: Todos</option>'+advs.map(v=>`<option>${v}</option>`).join('');
  const cliOpts = '<option value="">Cliente: Todos</option>'+clis.map(v=>`<option>${v}</option>`).join('');
  if(selAdv) selAdv.innerHTML = advOpts;
  if(selCli) selCli.innerHTML = cliOpts;
  if(selAdvOnly) selAdvOnly.innerHTML = advOpts.replace('Advogado: Todos','Todos');
  if(selCliOnly) selCliOnly.innerHTML = cliOpts.replace('Cliente: Todos','Todos');
}
function applyFilters(){
  // sub-abas podem sobrescrever os filtros
  const activeSub = document.querySelector('.subtab.active')?.dataset.sub || 'all';
  if(activeSub==='adv'){
    F.q=''; F.cli=''; F.hoje='';
    F.adv = $('#f_adv_only')?.value||'';
  }else if(activeSub==='cli'){
    F.q=''; F.adv=''; F.hoje='';
    F.cli = $('#f_cli_only')?.value||'';
  }else if(activeSub==='sit'){
    F.q=''; F.adv=''; F.cli='';
    F.hoje = $('#f_sit_only')?.value||'';
  }else{ // all
    F.q   = ($('#q')?.value||'').toLowerCase();
    F.adv = $('#f_adv')?.value||'';
    F.cli = $('#f_cli')?.value||'';
    F.hoje= $('#f_hoje')?.value||'';
  }
}

/* ===== Render ===== */
function render(){
  applyFilters();
  S.filtered = S.rows.filter(r=>{
    if(F.q && !`${r.id} ${r.prazo} ${r.advogado} ${r.cliente}`.toLowerCase().includes(F.q)) return false;
    if(F.adv && r.advogado!==F.adv) return false;
    if(F.cli && r.cliente!==F.cli) return false;
    if(F.hoje && r.hoje!==F.hoje) return false;
    return true;
  });

  const tb = $('#tb'); tb.innerHTML='';
  S.filtered.forEach(r=>{
    const badge = r.hoje==='OK'?'ok':(r.hoje==='A_VENCER'?'warn':'bad');
    const tr=document.createElement('tr'); tr.className = badge==='ok'?'row-ok':(badge==='warn'?'row-warn':'row-bad');
    tr.innerHTML = `<td>${r.id||''}</td><td>${r.prazo||''}</td><td>${r.advogado||''}</td><td>${r.cliente||''}</td>
      <td>${r.data_fatal? r.data_fatal.toLocaleDateString('pt-BR'):''}</td>
      <td>${r.data_envio? r.data_envio.toLocaleDateString('pt-BR'):''}</td>
      <td><span class="badge ${badge}">${r.sla}</span></td>
      <td>${r.du??''}</td>
      <td><span class="badge ${badge}">${r.hoje}</span></td>`;
    tb.appendChild(tr);
  });

  const total=S.filtered.length, late=S.filtered.filter(x=>x.hoje==='VENCIDO').length, ok=total-late;
  $('#k_total').textContent=total;
  $('#k_ok').textContent=ok;
  $('#k_late').textContent=late;
  $('#k_pct').textContent= total? Math.round(ok*100/total)+'%':'—';
  $('#rows').textContent = `${S.filtered.length} de ${S.rows.length} linhas`;
}

/* ===== Eventos ===== */
function fail(msg){ const e=$('#err'); if(e){ e.textContent='Erro: '+msg; e.style.display='block'; } }
document.addEventListener('click',e=>{
  if(e.target?.id==='filtrar') render();
  if(e.target?.id==='limpar'){
    if($('#q')) $('#q').value='';
    if($('#f_adv')) $('#f_adv').value='';
    if($('#f_cli')) $('#f_cli').value='';
    if($('#f_hoje')) $('#f_hoje').value='';
    render();
  }
  if(e.target?.id==='filtrar_adv') render();
  if(e.target?.id==='filtrar_cli') render();
  if(e.target?.id==='filtrar_sit') render();
});
</script>
</body>
</html>
